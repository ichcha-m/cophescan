#' Run the hierarchical metropolis hastings model to infer priors
#'
#' @param multi.dat matrix of bf values, rows=traits, named columns=("lBF.Ha","lBF.Hc","nsnps")
#' @param covar whether to include covariates
#' @param covar_vec vector of covariates
#' @param nits number of iterations
#' @param thin burnin
#' @param posterior default: F, estimate posterior probabilities of the hypotheses
#' @param avg_pik default: F, estimate the average of the pik
#' @param avg_posterior default: F, estimate the average of the posterior probabilities of the hypotheses
#' @param pik default: F, inferred prior probabilities
#' @param chains default: 1, number of chains
#' @param cores default: 1, number of cores
#' @param alpha_mean prior for the mean of  alpha
#' @param alpha_sd prior for the standard deviation of  alpha
#' @param beta_shape prior for the shape (gamma distibution) of beta
#' @param beta_scale prior for the scale of beta
#' @param gamma_shape prior for the shape (gamma distibution) of gamma
#' @param gamma_scale prior for the scale of gamma
#' @return List containing the posterior distribution of the parameters alpha, beta, gamma (if covariate included) and the loglikelihood
#' @return if avg_posterior=TRUE matrix with average of all the posterior probabilities of Hn, Ha and Hc
#' @return if avg_pik=TRUE matrix with average of all the priors: pn, pa and pc
#' @export
run_metrop_priors <- function(multi.dat, covar=FALSE, covar_vec=NULL, is_covar_categorical = F, nits=10000,
                              thin=1, posterior=F, avg_pik=T, avg_posterior=T,
                              pik=F, chains=1, cores=1, alpha_mean =-10,
                               alpha_sd=0.5,  beta_shape=2,  beta_scale=2,
                               gamma_shape=2,  gamma_scale=2){
  if (!is.data.frame(multi.dat)){
    pp_df <- multitrait.simplify(multi.dat)
    if (is.null(multi.dat)){return(NULL)}
  } else {
    pp_df <- multi.dat
  }
  if ('hit1'%in% colnames(pp_df) & (!'hit1'%in% colnames(pp_df))){
    pp_df$sus_labels <- rownames(pp_df) <- paste0(pp_df$hit1, '_hit_', pp_df$hit2)
  }
  if (covar) {
    if (!(length(covar_vec) == nrow(pp_df) )){
      stop('Length of covar_vec should be equal to the number of traits (length(multi.dat))')
    } else if (is.null(covar_vec)){
        stop('covar set to true but covar_vec not supplied')
    }
  }
  if (!covar & is.null(covar_vec)){
      message('covar_vec supplied but covar set to false, setting covar_vec to 1. Set covar to True if covariate to be included')
      covar_vec <- rep(1, nrow(pp_df))
  }

  lbf_mat <- as.matrix(pp_df[, c('lBF.Ha', 'lBF.Hc')])
  nsnps <- as.vector(pp_df[, "nsnps"])

  ## Run hierarchical model
  res.metrop <- metrop_run(lbf_mat = lbf_mat, nsnps = nsnps,
                           covar_vec = covar_vec, covar = covar, nits = nits, thin = thin,  alpha_mean =alpha_mean,
                           alpha_sd=alpha_sd,  beta_shape=beta_shape,  beta_scale=beta_scale,
                           gamma_shape=gamma_shape,  gamma_scale=gamma_scale)

  if (covar){
    rownames(res.metrop$parameters) <- c("alpha","beta","gamma")
  }else{
    rownames(res.metrop$parameters) <- c("alpha","beta")}
  ## piks from parameters
  if (pik){
    pik <- piks(res.metrop$parameters, nsnps = nsnps, covar_vec = covar_vec, covar=covar)
    res.metrop$pik <- pik
  }

  if (posterior){
    posterior <- posterior_prob(res.metrop$parameters, lbf_mat, nsnps = nsnps,
                                covar_vec = covar_vec, covar=covar)
    res.metrop$posterior <- posterior
  }

  if (avg_posterior){
    avg.posterior <- average_posterior_prob(res.metrop$parameters, lbf_mat,
                                            nsnps = nsnps, covar_vec = covar_vec,
                                            nits = nits, thin = thin, covar = covar)
    colnames(avg.posterior) <- c('Hn', 'Ha', 'Hc')
    res.metrop$avg.posterior <- avg.posterior
  }

  if (avg_pik){
    avg.pik <- average_piks(res.metrop$parameters, nsnps = nsnps,
                            covar_vec = covar_vec, nits = nits, thin = thin, covar = covar)
    colnames(avg.pik) <- c('pnk', 'pak', 'pck')
    res.metrop$avg.pik <- avg.pik
  }

  return(res.metrop)
}


